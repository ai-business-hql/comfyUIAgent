import{a as k,r as c,j as e,b as v}from"./input.js";function S(o,d){if(k==null)throw console.error("api is null!"),new Error("api is null!");return k.fetchApi(o,d)}var j;(o=>{async function d(h){try{return await(await S(`/workspace/fetch_messages_by_id?session_id=${h}`)).json()}catch(a){return console.error("Error fetching messages:",a),[]}}o.fetchMessages=d;async function*m(h,a){const b=(await S("/workspace/workflow_gen",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:h,message:a})})).body.getReader();let x="";for(;;){const{done:g,value:u}=await b.read();if(g)break;x+=new TextDecoder().decode(u);const i=x.split(`
`);x=i.pop()||"";for(const f of i)f.trim()&&(yield JSON.parse(f))}x.trim()&&(yield JSON.parse(x))}o.streamMessage=m})(j||(j={}));function A({onClose:o}){const[d,m]=c.useState([]),[h,a]=c.useState(""),[w,b]=c.useState(!1),[x,g]=c.useState(),u=c.useRef(null),[i,f]=c.useState(null);c.useEffect(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[d]);const _=async s=>{try{const t=await j.fetchMessages(s);m(t)}catch(t){console.error("Error fetching messages:",t)}};c.useEffect(()=>{let s=localStorage.getItem("sessionId");s?(g(s),_(s)):(s=crypto.randomUUID(),g(s),localStorage.setItem("sessionId",s))},[]),c.useEffect(()=>{const s=()=>{const t=v.canvas.selected_nodes;if(Object.keys(t??{}).length){const r=Object.values(t)[0];f(r)}else f(null)};return document.addEventListener("click",s),()=>{document.removeEventListener("click",s)}},[]);const C=s=>{a(s.target.value)},N=async()=>{if(h.trim()===""&&!i||!x)return;b(!0);const s={id:crypto.randomUUID(),role:"user",content:h,toolCalls:{}};m([...d,s]),a("");try{let t=null,r="";for await(const n of j.streamMessage(x,h))if(n.is_chunk){if(r+=n.content,t){const l={...t};if(l.type==="message")l.content=r;else{const y=JSON.parse(l.content||"{}");y.ai_message=r,l.content=JSON.stringify(y)}m(y=>y.map(p=>p.id===l.id?l:p))}}else{if(t=n,n.type==="message"||n.type==="workflow_option")try{r=JSON.parse(n.content||"{}").ai_message||""}catch{r=n.content||""}m(l=>l.some(p=>p.id===n.id)?l.map(p=>p.id===n.id?n:p):[...l,n])}}catch(t){console.error("Error sending message:",t)}finally{b(!1)}},I=s=>{s.metaKey&&s.key==="Enter"&&N()},M=()=>{m([]),localStorage.removeItem("sessionId");const s=crypto.randomUUID();g(s),localStorage.setItem("sessionId",s)},E=s=>`https://ui-avatars.com/api/?name=${s||"User"}&background=random`,O=()=>{o==null||o()},J=s=>{a(s)};return e.jsx("div",{className:"fixed top-0 right-0 h-full w-1/4 max-w-[300px] shadow-lg bg-white",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3 bg-white border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800",children:"Chat"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:"inline-flex items-center justify-center rounded-md p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-600 disabled:opacity-50",disabled:d.length===0,onClick:M,children:e.jsx(U,{className:"h-5 w-5"})}),e.jsx("button",{className:"inline-flex items-center justify-center rounded-md p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-600",onClick:O,children:e.jsx(T,{className:"h-5 w-5"})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",ref:u,children:e.jsx("div",{className:"grid gap-4",style:{color:"gray",minHeight:"min-content"},children:d.map(s=>s.role==="ai"||s.role==="tool"?e.jsxs("div",{className:"flex items-start gap-3 break-words resize-none",children:[e.jsx("div",{className:"relative h-10 w-10 flex-shrink-0 rounded-full overflow-hidden",children:e.jsx("img",{src:E(s.role),alt:s.role?s.role:"",width:"40",height:"40",className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm",children:s.name?s.name:"Assistant"}),s.type==="message"&&e.jsx("div",{className:"rounded-lg bg-blue-50 p-3 text-sm break-words overflow-hidden",children:s.content?(()=>{try{const t=JSON.parse(s.content);return e.jsxs("div",{className:"space-y-3",children:[t.ai_message&&e.jsx("p",{style:{whiteSpace:"pre-wrap",maxWidth:"100%",wordBreak:"break-word"},children:t.ai_message}),t.options&&t.options.length>0&&e.jsx("div",{className:"flex flex-col space-y-2",children:t.options.slice(0,3).map((r,n)=>e.jsx("button",{onClick:()=>J(r),className:`text-left px-4 py-2 rounded-md border border-gray-200 
                                                                                     hover:bg-gray-50 transition-colors duration-200 
                                                                                     text-sm text-gray-700 shadow-sm bg-white`,children:r},n))})]})}catch{return e.jsx("p",{dangerouslySetInnerHTML:{__html:s.content}})}})():null}),s.type==="workflow_option"&&(()=>{const t=JSON.parse(s.content);return e.jsxs("div",{className:"space-y-3",children:[t.ai_message&&e.jsx("p",{children:t.ai_message}),t.options&&t.options.length>0&&e.jsx("div",{className:"flex flex-col space-y-4",children:t.options.map((r,n)=>e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-lg border border-gray-200 hover:bg-gray-50",children:[e.jsx("img",{src:r.thumbnail,alt:r.name,className:"w-14 h-14 object-cover rounded-lg"}),e.jsxs("div",{className:"flex-1 max-w-[200px] break-words flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-lg",children:r.name}),e.jsx("p",{className:"text-gray-600 text-sm",children:r.description})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{onClick:async()=>{alert(r.workflow),v.loadGraphData(JSON.parse(r.workflow))},className:"px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm",children:"Accept"})})]})]},n))})]})})(),s.type==="node_search"&&(()=>{const t=JSON.parse(s.content);return e.jsxs("div",{className:"space-y-3",children:[t.existing_nodes&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 mb-2",children:"Available nodes that can be added to canvas:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.existing_nodes.map(r=>e.jsx("div",{children:e.jsx("button",{className:`px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded-md
                                                                                     text-blue-700 border border-blue-200 transition-colors text-sm`,style:{backgroundColor:"yellow"},onClick:()=>{const n=v.addNodeOnGraph({name:r.name});r.connect(0,n,0)},children:r.name})},r.name))})]}),t.non_existing_nodes&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 mt-4 mb-2",children:"Recommended nodes (requires installation):"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.non_existing_nodes.map(r=>e.jsx("div",{children:e.jsx("a",{href:r.github_url,target:"_blank",rel:"noopener noreferrer",className:`inline-block px-3 py-2 bg-gray-50 hover:bg-gray-100 
                                                                                    rounded-lg relative group text-gray-700 border 
                                                                                    border-gray-200 transition-colors`,style:{backgroundColor:"yellow"},children:r.name})},r.name))})]})]})})()]})]},s.id):e.jsxs("div",{className:"flex items-start gap-3 justify-end",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-right",children:s.name?s.name:"User"}),e.jsx("div",{className:"rounded-lg bg-blue-500 p-3 text-sm text-white break-words",children:e.jsx("p",{children:s.content})})]}),e.jsx("div",{className:"relative h-10 w-10 rounded-full overflow-hidden bg-white flex items-center justify-center",children:e.jsx("span",{children:"You"})})]},s.id))})}),e.jsxs("div",{className:"border-t px-4 py-3 border-gray-200 bg-white",children:[i&&e.jsxs("div",{className:"mb-3 p-3 rounded-md bg-gray-50 border border-gray-200",children:[e.jsx("h4",{className:"font-medium",children:"Selected Node:"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:["Type: ",i.type]}),e.jsxs("p",{children:["Title: ",i.title||"Untitled"]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded-md bg-blue-50 hover:bg-blue-100 text-blue-700 transition-colors",onClick:()=>a(`Explain how to use node: ${i.type}`),children:"查询节点使用方法"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-green-100 hover:bg-green-200 text-green-700 transition-colors",style:{backgroundColor:"yellow"},onClick:()=>a(`What are the parameters for node: ${i.type}`),children:"查询参数"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-purple-100 hover:bg-purple-200 text-purple-700 transition-colors",style:{backgroundColor:"yellow"},onClick:()=>a(`Recommend downstream nodes for: ${i.type}`),children:"下游节点推荐"})]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{onChange:C,onKeyDown:I,value:h,placeholder:"Type your message...",className:`w-full min-h-[80px] resize-none rounded-md border border-gray-200 
                                     px-3 py-2 pr-12 text-sm shadow-sm focus:outline-none 
                                     focus:ring-1 focus:ring-blue-500 bg-white`}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-gray-500",children:["Tip: Press ",e.jsx("kbd",{children:"Cmd"})," + ",e.jsx("kbd",{children:"Enter"})," to send"]}),e.jsx("button",{type:"submit",onClick:N,disabled:w,className:`absolute bottom-3 right-3 p-2 rounded-md text-gray-500 
                                     hover:bg-gray-100 hover:text-gray-600 disabled:opacity-50`,children:w?e.jsx("div",{className:"h-3 w-3"}):e.jsx(e.Fragment,{children:e.jsx(L,{className:"h-5 w-5",style:{color:"gray"}})})})]})]})]})})}function L(o){return e.jsxs("svg",{...o,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"m22 2-7 20-4-9-9-4Z"}),e.jsx("path",{d:"M22 2 11 13"})]})}function T(o){return e.jsxs("svg",{...o,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M18 6 6 18"}),e.jsx("path",{d:"m6 6 12 12"})]})}function U(o){return e.jsxs("svg",{...o,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]})}export{A as default};
